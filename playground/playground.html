<html>
  <title>LUCUMA-SSO LOCAL PLAYGROUND</title>
  <script>

    var ssoRootUri = "http://local.lucuma.xyz:8080"
    var jwt = null

    function parseJwt(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function authAsGuest() {
      var xhttp = new XMLHttpRequest()
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          setJwt(xhttp.responseText);
        }
      }
      xhttp.open("POST", ssoRootUri + "/api/v1/auth-as-guest", true);
      xhttp.withCredentials = true
      xhttp.send(null);
    }

    function authOrcid() {
      document.location = ssoRootUri + "/auth/v1/stage1?state=" + encodeURIComponent(document.location.href)
    }

    function logout() {
      var xhttp = new XMLHttpRequest()
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          init()
        }
      }
      xhttp.open("POST", ssoRootUri + "/api/v1/logout", true);
      xhttp.withCredentials = true
      xhttp.send(null);
    }

    function init() {
      document.getElementById("ssoRootUri").innerHTML = ssoRootUri

      var xhttp = new XMLHttpRequest()
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (xhttp.status == 403) {
            document.getElementById("whoami").innerHTML = "Not logged in."
          } else {
            setJwt(xhttp.responseText)
          }
        }
      }
      xhttp.open("POST", ssoRootUri + "/api/v1/refresh-token", true);
      xhttp.withCredentials = true
      xhttp.send(null);
    }

    function setJwt(newJwt) {
      jwt = newJwt
      var parsed    = parseJwt(jwt) // an object
      var formatted = JSON.stringify(parsed, null, 4)
      document.getElementById("whoami").innerHTML = formatted
    }

  </script>
  <style>
    body {
      font-family: sans-serif;
    }
    div {
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .preformatted {
      padding: 4px;
      border: 1px solid gray;
      background-color: lightgray;
      font-family: monospace;
      white-space: pre;
    }
  </style>
  <body onload="init()">

    <h1>LUCUMA-SSO PLAYGROUND</h1>

    <div>
      This page is hitting the SSO server at <span style="font-weight: bold;" id="ssoRootUri"></span>.
    </div>

    <div>
      <div id="whoami" class="preformatted">
      </div>
    </div>

    <ul>
      <li><a href="javascript:authAsGuest()">Log in as guest.</a></li>
      <li><a href="javascript:authOrcid()">Log in with ORCID.</a></li>
      <li><a href="javascript:logout()">Log out.</a></li>
    </li>

  </body>
</html>